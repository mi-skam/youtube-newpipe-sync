name: Sync YouTube Subscriptions

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Restore previous metadata and timeline
        run: |
          mkdir -p output
          # Fetch metadata.json and timeline.json from gh-pages branch if it exists
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "Fetching previous data from gh-pages branch..."
            if git fetch origin gh-pages:gh-pages 2>&1; then
              # Restore metadata.json
              if git show gh-pages:metadata.json > output/metadata.json 2>/dev/null; then
                echo "✅ Previous metadata restored"
                # Use jq if available, otherwise use grep/sed as fallback
                if command -v jq >/dev/null 2>&1; then
                  echo "Previous sync date: $(jq -r '.last_updated // "unknown"' output/metadata.json)"
                  echo "Previous subscription count: $(jq -r '.subscription_count // 0' output/metadata.json)"
                else
                  echo "Previous metadata file found (jq not available for detailed info)"
                fi
              else
                echo "⚠️  No previous metadata found in gh-pages (first run)"
              fi
              # Restore timeline.json
              if git show gh-pages:timeline.json > output/timeline.json 2>/dev/null; then
                echo "✅ Timeline history restored"
                if command -v jq >/dev/null 2>&1; then
                  echo "Timeline entries: $(jq -r '.entries | length' output/timeline.json)"
                fi
              else
                echo "⚠️  No previous timeline found (first run or new feature)"
              fi
            else
              echo "⚠️  Failed to fetch gh-pages branch"
            fi
          else
            echo "⚠️  gh-pages branch doesn't exist yet (first run)"
          fi
      - name: Fetch subscriptions
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: python sync.py
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          force_orphan: true
