name: Sync YouTube Subscriptions

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Restore previous metadata
        run: |
          mkdir -p output
          # Fetch metadata.json from gh-pages branch if it exists
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "Fetching previous metadata from gh-pages branch..."
            git fetch origin gh-pages:gh-pages 2>/dev/null || true
            if git show gh-pages:metadata.json > output/metadata.json 2>/dev/null; then
              echo "✅ Previous metadata restored"
              echo "Previous sync date: $(jq -r '.last_updated' output/metadata.json)"
              echo "Previous subscription count: $(jq -r '.subscription_count' output/metadata.json)"
            else
              echo "⚠️  No previous metadata found (first run)"
            fi
          else
            echo "⚠️  gh-pages branch doesn't exist yet (first run)"
          fi
      - name: Fetch subscriptions
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: python sync.py
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          force_orphan: true
